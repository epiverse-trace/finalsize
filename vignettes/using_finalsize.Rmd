---
title: "Calculating the final size of an epidemic outbreak"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Calculatinng the final size of an epidemic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Getting _finalsize_

The _finalsize_ package is currently available on [Github](https://github.com/epiverse-trace/finalsize), and can be installed using the `remotes` or `devtools` packages.

```{r setup, message=FALSE, warning=FALSE}
# first install the remotes packages
# install.packages("remotes")

# install finalsize using remotes
# remotes::install_github("epiverse-trace/finalsize")
library(finalsize)

# load useful packages
library(data.table)
library(ggplot2)
library(colorspace)
```

## Epidemic outbreak in a population with uniform susceptibility

This example uses social contact data from the [POLYMOD](https://cordis.europa.eu/project/id/502084) project to estimate the final size of an epidemic in the UK. These data are provided with the `socialmixr` package.

The contact data are divided into five age groups: 0 -- 5, 5 -- 18, 18 -- 40, 40 -- 65, and 65 and over, specified using the `age.limits` argument in `socialmixr::contact_matrix()`.
The `symmetric = TRUE` argument to `socialmixr::contact_matrix()` returns a symmetric contact matrix, so that the contacts reported by group _{i}_ of individuals from group _{j}_ are the same as those reported by group _{j}_ of group _{i}_.

The demographic data --- the number of individuals in each age group --- is also available through `socialmixr::contact_matrix()`.

```{r}
# get UK polymod data
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 5, 18, 40, 65),
  symmetric = TRUE
)

# get the contact matrix and demography data
contact_matrix <- t(contact_data$matrix)
demography_vector <- contact_data$demography$population

# scale the contact matrix so the largest eigenvalue is 1.0
contact_matrix <- contact_matrix / max(eigen(contact_matrix)$values)

# divide each row of the contact matrix by the corresponding demography
contact_matrix <- contact_matrix / demography_vector

n_demo_grps <- length(demography_vector)
```

In the early stages of an epidemic outbreak, it may be unclear how susceptibility to the disease varies with individual characteristic, such as age. An initial, safe assumption might be that all age groups have a similar susceptibility. 

When the outbreak is of a novel pathogen or strain, the initial assumption might also be that all individuals, regardless of age, have a high susceptibility to the disease. Later sections will show how to implement different assumptions.

```{r}
# all individuals are equally and highly susceptible
n_susc_groups <- 1L
susc_guess <- 1.0
```

We model high uniform susceptibility as a matrix with values the range 0.0 -- 1.0, with as many rows as there are demography groups. Higher values indicate higher susceptibility. The matrix has a single column, representing the single susceptibility group to which all these individuals belong.

```{r}
susc_uniform <- matrix(
  data = susc_guess,
  nrow = n_demo_grps,
  ncol = n_susc_groups
)
```

Individuals within age groups do not differ in their susceptibility, and we model this as a matrix with as many rows as there are demography groups. The matrix has a single column indicating the proportion of each age group expected to be in each susceptibility group.

This demography-susceptibility spread matrix is subject to the constraint that each of its rows must sum to 1.0, as each row represents the division of each age group into susceptibility groups.

```{r}
p_susc_uniform <- matrix(
  data = 1.0,
  nrow = n_demo_grps,
  ncol = n_susc_groups
)
```

Along with uncertainty around population susceptibility to the disease, disease attributes such as the reproduction number R<sub>0</sub> might be uncertain in the early stages of an outbreak.

Using _finalsize_, we can quickly calculate the proportion of individuals infected in each demographic group for a broad range of R<sub>0</sub>. Here, we shall consider values of 1.3, 2.0, 3.0, 5.0, and 9.0.

These correspond roughly to the R<sub>0</sub> of directly transmitted respiratory diseases: influenza strains (1.3 -- 2.0), the original Covid-19 strain (2.0 -- 3.0), the Covid-19 Alpha and Delta variants (≈ 5.0), and the Covid-19 Omicron variant and its subtypes (≈ 9.0).

```{r}
r0_range <- c(1.3, 2.0, 3.0, 5.0, 9.0)
```

```{r}
# we run final size over all r0 values
final_sizes <- lapply(
  X = r0_range,
  FUN = function(r0) {
    df <- final_size(
      r0 = r0,
      contact_matrix = contact_matrix,
      demography_vector = demography_vector,
      susceptibility = susc_uniform,
      p_susceptibility = p_susc_uniform
    )

    df$r0 <- r0

    df
  }
)
```

We can prepare this data for a simple visualisation that shows how the increasing R<sub>0</sub> of a disease affects the final size of the epidemic in this population.

```{r}
# prepare data as a dataframe
final_sizes <- rbindlist(final_sizes)

# prepare age group order
final_sizes$demo_grp <- factor(
  final_sizes$demo_grp,
  levels = contact_data$demography$age.group
)
```

We can visualise the final sizes as proportion of each age group infected, with colours indicating the R<sub>0</sub> of the disease.

```{r echo=FALSE, fig.cap = "Final size of an epidemic in a population with high susceptibility to disease in all age groups. In this example, over 25% of all age groups except the over-65s are infected when the disease has an R<sub>0</sub> of 1.3, equivalent to seasonal influenza. This reflects the greater social contacts of these groups. In contrast, diseases with an R<sub>0</sub> of 5.0 or 9.0 would infect nearly the same proportion of people in all age groups, reflecting their increased transmissibility."}
# plot as columns
ggplot(final_sizes) +
  geom_col(
    aes(
      x = demo_grp, y = p_infected,
      fill = as.factor(r0)
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_fill_discrete_sequential(
    palette = "Purple-Yellow",
    name = "R<sub>0</sub>"
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "% Infected"
  )
```

## From final size proportions to counts

`finalsize` returns the _proportion_ of each age (and risk) group infected in an epidemic outbreak. These proportions can be be converted into population counts --- numbers of people --- by multiplication with the demography vector.

The example below show how this can be done.

```{r}
# prepare demography data
demography_data <- contact_data$demography

# merge final size counts with demography vector
final_sizes <- merge.data.table(
  final_sizes,
  demography_data,
  by.x = "demo_grp",
  by.y = "age.group"
)

# reset age group order
final_sizes$demo_grp <- factor(
  final_sizes$demo_grp,
  levels = contact_data$demography$age.group
)

# multiply counts with prportion infected
final_sizes[, n_infected := p_infected * population]
```

The final _counts_ infected can be visualised as well.

```{r echo=FALSE, fig.cap="Final size of an epidemic outbreak in a population, for different values of disease R<sub>0</sub>. Converting the final size proportions in each age group to counts shows that individuals aged 18 -- 65 make up the bulk of cases in most disease outbreaks. This may be attributed to this being both the largest age range in the analysis (more years in this range than any other), and because more people fall into this wide range than others. Contrast this figure with the one above, in which similar _proportions_ of each age group are infected."}
ggplot(final_sizes) +
  geom_col(
    aes(
      x = demo_grp, y = n_infected,
      fill = as.factor(r0)
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_fill_discrete_sequential(
    palette = "Blue-Yellow",
    name = "R<sub>0</sub>"
  ) +
  scale_y_continuous(
    labels = scales::comma_format(
      scale = 1e-6, suffix = "M"
    )
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "Number infected (millions)"
  )
```

---

## Age group contribution to final sizes

The contribution of each age group to the outbreak's final size can be calculated as the number of individuals in each age group infected as a proportion of the total number of individuals infected in the outbreak.

This can help show which age groups are most influential for epidemic dynamics.

```{r}
# calculate the proportional contribution to final size of the epidemic
final_sizes[, p_contribution := n_infected / sum(n_infected),
            by = c("r0")]
```

```{r echo=FALSE, fig.cap="insert caption here"}
ggplot(final_sizes) +
  geom_col(
    aes(
      x = as.factor(r0), y = p_contribution,
      fill = demo_grp
    ),
    col = "black",
    position = position_stack(
      reverse = TRUE
    )
  ) +
  scale_fill_discrete_sequential(
    palette = "Hawaii",
    name = "Age group"
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  guides(
    fill = guide_legend(
      reverse = TRUE
    )
  ) +
  labs(
    x = "R<sub>0</sub>",
    y = "% of final epidemic size"
  ) +
  theme(
    axis.title.x = ggtext::element_markdown()
  )
```

```{r echo=FALSE, fig.cap="Difference between the proportion of individuals in each age group infected, and the proportion of the corresponding in the population. Compared to previous visualisations, this figure shows that some groups are disproportionately infected relative to their population proportion. This effect is especially noticeable for less transmissible diseases. For example, the age group 5 -- 18 are infected substantially more than their population proportion, which is not always visible in the proportion, or raw counts of final sizes. Conversely, the age group 40 -- 65, despite making up a large number of overall cases, has a lower proportion infected than their proportion in the population."}
ggplot(final_sizes) +
  geom_hline(
    yintercept = 0,
    lty = 3
  ) +
  geom_col(
    aes(
      x = as.factor(r0), 
      y = p_contribution - proportion,
      fill = demo_grp
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  scale_fill_discrete_sequential(
    palette = "Hawaii",
    name = "Age group"
  ) +
  guides(
    fill = guide_legend(
      reverse = TRUE
    )
  ) +
  labs(
    x = "R<sub>0</sub>",
    y = "Difference b/w proportion infected\
    and population proportion"
  ) +
  theme(
    axis.title.x = ggtext::element_markdown()
  )
```


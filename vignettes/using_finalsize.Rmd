---
title: "Calculating the final size of an epidemic outbreak"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
    toc: true
bibliography: references.bib
vignette: >
  %\VignetteIndexEntry{Calculatinng the final size of an epidemic}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE
)
```

## Getting _finalsize_

The _finalsize_ package is currently available on [Github](https://github.com/epiverse-trace/finalsize), and can be installed using the `remotes` or `devtools` packages.

```{r setup, message=FALSE, warning=FALSE}
# first install the remotes packages
# install.packages("remotes")

# install finalsize using remotes
# remotes::install_github("epiverse-trace/finalsize")
library(finalsize)

# load useful packages
library(data.table)
library(ggplot2)
library(colorspace)
```

## Getting contact and demography data

This example uses social contact data from the [POLYMOD](https://cordis.europa.eu/project/id/502084) project to estimate the final size of an epidemic in the UK. These data are provided with the `socialmixr` package.

The contact data are divided into five age groups: 0 -- 5, 5 -- 18, 18 -- 40, 40 -- 65, and 65 and over, specified using the `age.limits` argument in `socialmixr::contact_matrix()`.
The `symmetric = TRUE` argument to `socialmixr::contact_matrix()` returns a symmetric contact matrix, so that the contacts reported by group _{i}_ of individuals from group _{j}_ are the same as those reported by group _{j}_ of group _{i}_.

The demographic data --- the number of individuals in each age group --- is also available through `socialmixr::contact_matrix()`.

```{r}
# get UK polymod data
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 5, 18, 40, 65),
  symmetric = TRUE
)

# get the contact matrix and demography data
contact_matrix <- t(contact_data$matrix)
demography_vector <- contact_data$demography$population
demography_data <- contact_data$demography

# scale the contact matrix so the largest eigenvalue is 1.0
contact_matrix <- contact_matrix / max(eigen(contact_matrix)$values)

# divide each row of the contact matrix by the corresponding demography
contact_matrix <- contact_matrix / demography_vector

n_demo_grps <- length(demography_vector)
```

## Basic usage: Epidemic outbreak with uniform susceptibility

In the early stages of an epidemic outbreak, it may be unclear how susceptibility to the disease varies with individual characteristic, such as age. An initial, safe assumption might be that all age groups have a similar susceptibility. 

When the outbreak is of a novel pathogen or strain, the initial assumption might also be that all individuals, regardless of age, have a high susceptibility to the disease. Later sections will show how to implement different assumptions.

```{r}
# all individuals are equally and highly susceptible
n_susc_groups <- 1L
susc_guess <- 1.0
```

We model high uniform susceptibility as a matrix with values in the range 0.0 -- 1.0, with as many rows as there are demography groups. Higher values indicate higher susceptibility. The matrix has a single column, representing the single susceptibility group to which all these individuals belong.

```{r}
susc_uniform <- matrix(
  data = susc_guess,
  nrow = n_demo_grps,
  ncol = n_susc_groups
)
```

Individuals within age groups do not differ in their susceptibility, and we model this as a matrix with as many rows as there are demography groups. The matrix has a single column indicating the proportion of each age group expected to be in each susceptibility group.

This demography-susceptibility spread matrix is subject to the constraint that each of its rows must sum to 1.0, as each row represents the division of each age group into susceptibility groups.

```{r}
p_susc_uniform <- matrix(
  data = 1.0,
  nrow = n_demo_grps,
  ncol = n_susc_groups
)
```

### Running final_size

We assume that the disease has an $R_0$ of 2.0, similar to some strains of seasonal influenza. The final size of the epidemic in the population can then be calculated as follows.

```{r}
# define r0 as 2.0
r0 <- 2.0

# calculate final size
final_size_data <- final_size(
  r0 = r0,
  contact_matrix = contact_matrix,
  demography_vector = demography_vector,
  susceptibility = susc_uniform,
  p_susceptibility = p_susc_uniform
)

# order demographic groups
final_size_data$demo_grp = factor(
  final_size_data$demo_grp,
  levels = demography_data$age.group
)
```

### Visualise final sizes

```{r echo=FALSE, fig.cap = "Some caption here"}
# plot data
ggplot(final_size_data) +
  geom_col(
    aes(
      demo_grp, p_infected
    ),
    fill = "grey",
    col = "black"
  ) +
  scale_fill_discrete_sequential(
    palette = "Purple-Yellow",
    name = "$R_0$"
  ) +
  scale_y_continuous(
    labels = scales::percent,
    limits = c(0, 1)
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "% Infected"
  )

```

## Uncertainty in $R_0$

The reproduction number $R_0$ might be uncertain in the early stages of an outbreak. We can model this uncertainty in the $R_0$ by running `final_size` multiple times for the same contact and demography data, while sampling $R_0$ values from a distribution.

We assume that estimates of the disease's $R_0$ are from a normal distribution $N(\mu = 2.0, \sigma = 0.1)$. We shall draw 1,000 samples of $R_0$ and run `final_size` on the contact data and demography data for each sample.

Use cases like this demonstrate the benefits of writing `finalsize` with a C++ backend.

```{r}
# create an R0 samples vector
r0_samples <- rnorm(n = 1000, mean = 2.0, sd = 0.1)
```

```{r}
# run final size on each sample with the same data
final_size_data <- Map(
  r0_samples, seq_along(r0_samples),
  f = function(r0, i) {
    fs <- final_size(
      r0 = r0,
      contact_matrix = contact_matrix,
      demography_vector = demography_vector,
      susceptibility = susc_uniform,
      p_susceptibility = p_susc_uniform
    )
    
    fs$replicate <- i
    fs
  }
)

# combine data
final_size_data = rbindlist(final_size_data)

# order age groups
final_size_data$demo_grp = factor(
  final_size_data$demo_grp,
  levels = demography_data$age.group
)
```

### Visualise uncertainty in final size

```{r echo=FALSE}
ggplot(final_size_data) +
  geom_boxplot(
    aes(
      demo_grp, p_infected
    ),
    outlier.size = 0.2
  ) +
  scale_fill_discrete_sequential(
    rev = FALSE
  ) +
  scale_y_continuous(
    labels = scales::percent,
    limits = c(0, 1)
  ) +
  labs(
    x = "Age group",
    y = "% Infected"
  )
```

### From final size proportions to counts

`finalsize` returns the _proportion_ of each age (and risk) group infected in an epidemic outbreak. These proportions can be be converted into population counts --- numbers of people --- by multiplication with the demography vector.

The example below show how this can be done.

```{r}
# prepare demography data
demography_data <- contact_data$demography

# merge final size counts with demography vector
final_size_data <- merge.data.table(
  final_size_data,
  demography_data,
  by.x = "demo_grp",
  by.y = "age.group"
)

# reset age group order
final_size_data$demo_grp <- factor(
  final_size_data$demo_grp,
  levels = contact_data$demography$age.group
)

# multiply counts with prportion infected
final_size_data[, n_infected := p_infected * population]
```

The final _counts_ infected can be visualised as well.

```{r echo=FALSE, fig.cap="Final size of an epidemic outbreak in a population, for different values of disease $R_0$. Converting the final size proportions in each age group to counts shows that individuals aged 18 -- 65 make up the bulk of cases in most disease outbreaks. This may be attributed to this being both the largest age range in the analysis (more years in this range than any other), and because more people fall into this wide range than others. Contrast this figure with the one above, in which similar _proportions_ of each age group are infected."}
ggplot(final_size_data) +
  geom_boxplot(
    aes(
      x = demo_grp, y = n_infected
    )
  ) +
  scale_y_continuous(
    labels = scales::comma_format(
      scale = 1e-6, suffix = "M"
    )
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "Number infected (millions)"
  )
```

---

### Age group contribution to final sizes

The contribution of each age group to the outbreak's final size can be calculated as the number of individuals in each age group infected as a proportion of the total number of individuals infected in the outbreak.

This can help show which age groups are most influential for epidemic dynamics.

```{r}
# calculate the proportional contribution to final size of the epidemic
final_size_data[, p_contribution := n_infected / sum(n_infected),
                by = c("replicate")]
```

```{r echo=FALSE, fig.cap="insert caption here"}
ggplot(final_size_data) +
  geom_boxplot(
    aes(
      x = demo_grp, y = p_contribution
    )
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  guides(
    fill = guide_legend(
      reverse = TRUE
    )
  ) +
  labs(
    x = "Age group",
    y = "% of final epidemic size"
  )
```

---
title: "Comparing immunisation scenarios"
rmarkdown::html_vignette:
  fig_caption: yes
  toc: yes
vignette: >
  %\VignetteIndexEntry{Comparing immunisation scenarios}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette shows how to compare the final sizes of epidemic outbreaks for different underlying assumptions about population susceptibility, and the distribution of the population into susceptibility groups.

This example focuses on differences in susceptibility caused due to immunisation, for example as the result of a vaccination campaign.

### Getting _finalsize_ {-}

Get _finalsize_ from Github using `remotes`.

```{r setup, message=FALSE, warning=FALSE}
# first install the remotes packages
# install.packages("remotes")
# install finalsize using remotes
# remotes::install_github("epiverse-trace/finalsize", ref = "dev/single_func")
library(finalsize)
```

```{r}
# load useful packages
library(data.table)
library(ggplot2)
```

## Background and disease parameters

This example considers a single disease with an R<sub>0</sub> of 3.0, similar to the original strain of Covid-19.

```{r}
# set an r0 of about 3.0
r0 <- 3.0
```

## Get social contact data

This example the same data from the _POLYMOD_ dataset for the U.K. that is used in the [basic usage vignette](using_finalsize.html).

Here the population is divided into five age groups 0 -- 5, 5 -- 18, 18 -- 40, 40 -- 65, and 65+, specified using the `age.limits` argument in `socialmixr::contact_matrix()`. The number of contacts between age groups is normalised by the proportions of those groups in the population using the `split = TRUE` argument to `socialmixr::contact_matrix()`.

The demographic data --- the proportion of individuals in each age group --- is also available through `socialmixr::contact_matrix()`.

```{r}
# get UK polymod data
polymod <- socialmixr::polymod
contact_data <- socialmixr::contact_matrix(
  polymod,
  countries = "United Kingdom",
  age.limits = c(0, 5, 18, 40, 65),
  split = TRUE
)

# get the contact matrix and demography data
contact_matrix <- t(contact_data$matrix)
demography_vector <- contact_data$demography$population

# add names to demography vector
names(demography_vector) <- contact_data$demography$age.group

# scale the contact matrix so the largest eigenvalue is 1.0
contact_matrix <- contact_matrix / max(eigen(contact_matrix)$values)

# divide each row of the contact matrix by the corresponding demography
contact_matrix <- contact_matrix / demography_vector

n_demo_grps <- length(demography_vector)
```

## Comparing epidemic outcomes with immunisation

This first example shows how to compare between two scenarios: (1) a _baseline_ scenario in which the population is not immunised, and (2) an _intervention_ scenario in which the population is partially immunised, with immunisation reducing individual susceptibility.

```{r}
# define a susceptibility matrix
# susceptibility is uniform across age groups
susceptibility <- matrix(
  data = 1.0,
  nrow = n_demo_grps,
  ncol = 1L
)

# create group names
colnames(susceptibility) <- "Non-immunised"
```

First we address the effect of immunisation on susceptibility. We model this effect as a 50% reduction in susceptibility.

```{r}
# immunisation efficacies
immunisation_efficacy <- 0.5

susc_immunised <- cbind(
  susceptibility,
  susceptibility * (1 - immunisation_efficacy)
)

colnames(susc_immunised) <- c("Non-immunised", "Immunised")

# create named list with susceptibility matrices
susc_immunised_list <- list(
  "baseline" = susceptibility,
  "intervention" = susc_immunised
)
```

Next we define the proportions of each age group that have been immunised. We model a campaign with 50% uptake in each age group.

```{r}
# prepare p_susceptibility for baseline scenario
p_susceptibility <- matrix(
  data = 1.0,
  nrow = n_demo_grps,
  ncol = 1
)

# prepare p_susceptibility for intervention scenario
p_susc_immunised <- matrix(
  data = 0.5,
  nrow = n_demo_grps,
  ncol = 2 # for two susceptibility groups
)

# prepare a list for iterations
p_susc_list <- list(
  "baseline" = p_susceptibility,
  "intervention" = p_susc_immunised
)
```

We run `final_size` for the same contact matrix and disease R<sub>0</sub> with the different susceptibility matrices, to model the final size of the outbreak in the different immunisation scenarios.

```{r}
# run final size for different susceptibility matrices
final_sizes <- Map(
  susc_immunised_list, p_susc_list,
  f = function(x, y) {
    fs <- final_size(
      r0 = r0,
      contact_matrix = contact_matrix,
      demography_vector = demography_vector,
      susceptibility = x,
      p_susceptibility = y
    )

    # set demography order
    fs$demo_grp <- factor(
      fs$demo_grp,
      levels = names(demography_vector)
    )

    fs
  }
)
```

## Comparing scenario outcomes

```{r}
# assign scenario to each data frame
final_sizes <- Map(
  final_sizes, names(final_sizes),
  f = function(df, scenario) {
    df$scenario <- scenario
    df
  }
)

final_sizes <- rbindlist(final_sizes)

final_sizes$susc_grp <- factor(
  final_sizes$susc_grp,
  levels = c("Non-immunised", "Immunised")
)
```

### Overall outcomes

Here, we compare the _baseline_ and _intervention_ scenarios overall. This requires summarising the intervention scenario over age groups, and taking the average of the percentage infected in each age group.

```{r}
# use data.table features to summarise over demo_grp, scenario
final_sizes_summary <- final_sizes[, list(
  p_infected = mean(p_infected)
), by = c("demo_grp", "scenario")]
```

```{r echo=FALSE}
ggplot(final_sizes_summary) +
  geom_col(
    aes(
      demo_grp, p_infected,
      fill = scenario
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_fill_manual(
    values = c(
      "baseline" = "grey",
      "intervention" = "steelblue"
    ),
    labels = c(
      "baseline" = "Baseline",
      "intervention" = "Immunisation"
    ),
    name = "Group"
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "% Infected"
  )
```

### Differences between immunisation groups

```{r echo=FALSE}
ggplot(final_sizes) +
  geom_col(
    aes(
      demo_grp, p_infected,
      fill = interaction(susc_grp, scenario)
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_fill_manual(
    values = c(
      "Non-immunised.baseline" = "grey",
      "Non-immunised.intervention" = "lightblue",
      "Immunised.intervention" = "steelblue"
    ),
    labels = c(
      "Non-immunised.baseline" = "Baseline",
      "Non-immunised.intervention" = "Intervention: Non-immunised",
      "Immunised.intervention" = "Intervention: Immunised"
    ),
    name = "Group"
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm"),
    legend.title = ggtext::element_markdown(
      vjust = 1
    )
  ) +
  labs(
    x = "Age group",
    y = "% Infected"
  )
```

## Multiple immunisation scenarios

Here, we show how to compare multiple immunisation scenarios, as well as a no-immunisation scenario.

Since routine immunisation for many diseases is globally common, we shall set the _baseline_ scenario to be an **immunisation** scenario, with limited vaccine efficacy.


```{r}
# immunisation efficacies
immunisation_efficacy_high <- 0.75

# make a susceptibility matrix and set column names
susc_immunised_high <- cbind(
  susceptibility,
  susceptibility * (1 - immunisation_efficacy_high)
)

colnames(susc_immunised_high) <- c("Non-immunised", "Immunised")

# create named list with susceptibility matrices
susc_immunised_list <- list(
  "baseline" = susc_immunised,
  "new_vaccine" = susc_immunised_high,
  "no_vaccine" = susceptibility
)

# create a named list of p_susceptibility
p_susc_list <- list(
  "baseline" = p_susc_immunised,
  "new_vaccine" = p_susc_immunised, # reuse for new vaccine
  "no_vaccine" = p_susceptibility
)
```

Iterate over scenarios... add text.

```{r}
# get final sizes
final_sizes <- Map(
  susc_immunised_list, p_susc_list,
  f = function(x, y) {
    fs <- final_size(
      r0 = r0,
      contact_matrix = contact_matrix,
      demography_vector = demography_vector,
      susceptibility = x,
      p_susceptibility = y
    )

    # set demography order
    fs$demo_grp <- factor(
      fs$demo_grp,
      levels = names(demography_vector)
    )

    fs
  }
)

# add scenario names
final_sizes <- Map(
  final_sizes, names(final_sizes),
  f = function(df, x) {
    df$scenario <- x
    df
  }
)
```

```{r}
# collect data and prepare for plotting
final_sizes <- rbindlist(final_sizes)

# set susceptibility group factor outcomes
final_sizes$susc_grp <- factor(
  final_sizes$susc_grp,
  levels = c("Non-immunised", "Immunised")
)
```

### Visualise scenario outcomes in relation to baseline

First we summarise over susceptibility groups to get the average epidemic size in each age group, for each scenario.

```{r}
# summarise using data.table features
final_sizes_summary <- final_sizes[, list(
  p_infected = mean(p_infected)
), by = c("demo_grp", "scenario")]
```

```{r}
# calculate epidemic final sizes in relation to baseline
final_sizes_summary <- final_sizes_summary[, p_infected_change := p_infected - 
                      p_infected[scenario == "baseline"]
][scenario != "baseline", ]

# set factor levels
final_sizes_summary$scenario = factor(
  final_sizes_summary$scenario,
  levels = c("no_vaccine", "new_vaccine")
)
```

```{r echo=FALSE}
ggplot(final_sizes_summary) +
  geom_col(
    aes(
      demo_grp, p_infected_change,
      fill = scenario
    ),
    col = "black",
    position = position_dodge(
      width = 0.75
    )
  ) +
  scale_fill_manual(
    name = "Scenario",
    labels = c(
      "no_vaccine" = "No immunisation",
      "new_vaccine" = "Increased immunisation efficacy (75%)"
    ),
    values = c(
      "no_vaccine" = "indianred",
      "new_vaccine" = "steelblue"
    )
  ) +
  coord_cartesian(
    ylim = c(-0.25, 0.25)
  ) +
  scale_y_continuous(
    labels = scales::percent
  ) +
  theme(
    legend.position = "top",
    legend.key.height = unit(2, "mm")
  ) +
  labs(
    x = "Age group",
    y = "% Infected relative to baseline"
  )
```
